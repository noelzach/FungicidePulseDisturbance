---
title: "DiversityAnalysis"
author: "Zachary Noel"
date: "1/7/2021"
output: html_document
---

# Loading packages
```{r SOURCE}
source('functions_themes.R')
```

```{r setup, include=FALSE}
#source('http://bioconductor.org/biocLite.R')
#biocLite('phyloseq')
library(phyloseq)
library(decontam)
#browseVignettes("phyloseq")

packages <- c("biomformat", "qiimer", "MASS", "ape", "ggplot2", "plyr", "indicspecies", "labdsv", "dplyr", "reshape", "vegan", "metacoder", "lme4", "lsmeans", "ggpmisc", "ggpubr", "tidyverse", "doParallel", "DT", "exactRankTests", "foreach", "Rcpp", "shiny", "coin", "igraph", "SpiecEasi", "ggsci", "RCy3", "ggrepel", "cowplot", "ggalt", "ggfortify", "emmeans", "data.table", "randomForest", "rfUtilities", "caret", "tidyr")
ipak(packages)

packageVersion("vegan")
packageVersion('phyloseq')

#install.packages("remotes")
#remotes::install_github("DanielSprockett/reltools")
library(reltools)
#install.packages("minpack.lm")
library(minpack.lm)
#Models for the whole community
#install.packages("devtools")
library(devtools)
#install_github("DanielSprockett/tyRa")
#install.packages("Hmisc")
library(Hmisc)
library(Biostrings)
library(ggforce)
library(cowplot)
library(randomForest)
library(rfUtilities) # to test model significance
library(caret) # to get leave-one-out cross-validation accuracies and also contains the nearZeroVar function 
library(NetworkExtinction)
library(ggraph)
library(tidygraph)
library(metagenomeSeq)
```

# Prokaryotes
```{r}
# Restore the object
bacteria.no.norm <- readRDS(file = "Preprocessing/Fungicide_Bacteria_RootsAndLeaves_newtaxa_nonorm_010621.rds")
# Restore the object
bacteria.css.norm <- readRDS(file = "Preprocessing/Fungicide_Bacteria_RootsAndLeaves_newtaxa_CSSnorm_010621.rds")
```

```{r}
bacteria.no.norm.soy <- bacteria.no.norm %>% 
  subset_samples(Crop == "Soy") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

bacteria.css.norm.soy <- bacteria.css.norm %>% 
  subset_samples(Crop == "Soy") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

bacteria.no.norm.corn <- bacteria.no.norm %>% 
  subset_samples(Crop == "Corn") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

bacteria.css.norm.corn <- bacteria.css.norm %>% 
  subset_samples(Crop == "Corn") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 
```

## Alpha diversity on prokaryotes
-Switch out the alpha diversity estimate to test different measures
```{r}
#This line is to subset the dataset to a specific lineage
#physeq_prok_no_norm_sphingo = subset_taxa(bacteria.no.norm, Genus=="Hymenobacter") %>% phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE)

alpha.diversity.calc <- function(phyloseq.object) {
  phyloseq.object@sam_data$shannon <- estimate_richness(phyloseq.object, measures=c("Shannon"))$Shannon
phyloseq.object@sam_data$invsimpson <- estimate_richness(phyloseq.object, measures=c("InvSimpson"))$InvSimpson
phyloseq.object@sam_data$sequence_depth <- as.numeric(sample_sums(phyloseq.object))
phyloseq.object@sam_data$richness <- estimate_richness(phyloseq.object, measures=c("Observed"))$Observed
phyloseq.object@sam_data$even <- phyloseq.object@sam_data$shannon/log(phyloseq.object@sam_data$richness)

sample.data.bacteria <- data.frame(phyloseq.object@sam_data)
sample.data.bacteria$DateSampled <- as.Date(sample.data.bacteria$DateSampled, "%d-%b-%y")

# change out the alpha diversity measure here... 
lm.shannon.bacteria.rare <- lmer(richness ~ Fungicide*GrowthStage*Treatment*Compartment + (1|Rep), data = sample.data.bacteria)
return.list <- list(car::Anova(lm.shannon.bacteria.rare), sample.data.bacteria)
return(return.list)
}
alpha.diversity.calc(bacteria.no.norm.soy)[[1]]
alpha.diversity.calc(bacteria.no.norm.corn)[[1]]
```
Richness - dependent on the GrowthStage Treatment Compartment, log transformed richness does not violate the homoskedasticity assumption.
Shannon - dependent on Growthstage Treatment and Compartemnt
Evenness - dependent on Growthstage and Compartemnt primarily

## Prokaryote Beta-diversity

As expected, Prokaryotes varied by crop species, and plant compartment as did fungi. They also varied throughout the season and by treatment. But there is no substantial evidence that community composition varied by fungicide application

TABLE S5
```{r SOY LEAF - FUNGICIDE ADONIS}
#### Full Model ####
bacteria.norm.leaf.soy <- bacteria.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Soy") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

bacteria.norm.leaf.soy.bray = phyloseq::distance(bacteria.norm.leaf.soy, "bray") # create bray-curtis distance matrix

adonis2(bacteria.norm.leaf.soy.bray~Fungicide*Treatment*GrowthStage, as(sample_data(bacteria.norm.leaf.soy), "data.frame"), by = "margin") 

###### R3 - Bacteria leaves Soybean #####
bacteria.norm.leaf.soy.R3 <- bacteria.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Soy" & GrowthStage == "R3") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 
bacteria.norm.leaf.soy.R3@sam_data
bacteria.norm.leaf.soy.bray = phyloseq::distance(bacteria.norm.leaf.soy.R3, "bray") # create bray-curtis distance matrix

## Set up factors for the Plots and Blocks
plts <- gl(2, 3) ## 2 Plots (Fungicide & control) of 3 samples each for each time point
blks <- gl(4,6) ## 4 Blocks of 6 samples each

## permutation design
h1 <- how(within = Within(type = "series", mirror = TRUE),
          plots = Plots(strata = plts, type = "series"),
          blocks = blks, nperm = 9999)

adonis2(bacteria.norm.leaf.soy.bray~Fungicide*Treatment + Rep, as(sample_data(bacteria.norm.leaf.soy.R3), "data.frame"), permutations = h1) 

####### R4 - Bacteria leaves Soybean ######
bacteria.norm.leaf.soy.R4 <- bacteria.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Soy" & GrowthStage == "R4") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

bacteria.norm.leaf.soy.bray = phyloseq::distance(bacteria.norm.leaf.soy.R4, "bray") # create bray-curtis distance matrix

adonis2(bacteria.norm.leaf.soy.bray~Fungicide*Treatment, as(sample_data(bacteria.norm.leaf.soy.R4), "data.frame"), permutations = 9999) 

######## R6 - Bacteria leaves Soybean #######
bacteria.norm.leaf.soy.R6 <- bacteria.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Soy" & GrowthStage == "R6") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

bacteria.norm.leaf.soy.bray = phyloseq::distance(bacteria.norm.leaf.soy.R6, "bray") # create bray-curtis distance matrix

adonis2(bacteria.norm.leaf.soy.bray~Fungicide*Treatment, as(sample_data(bacteria.norm.leaf.soy.R6), "data.frame"), permutations = 9999) 
``` 
 
TABLE S5
```{r SOY ROOT - FUNGICIDE}
#### Full Model ####
bacteria.norm.root.soy <- bacteria.css.norm %>% 
  subset_samples(Compartment == "Root" & Crop == "Soy") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

bacteria.norm.root.soy.bray = phyloseq::distance(bacteria.norm.root.soy, "bray") # create bray-curtis distance matrix

adonis2(bacteria.norm.root.soy.bray~Fungicide*Treatment*GrowthStage, as(sample_data(bacteria.norm.root.soy), "data.frame")) 

#### R3 - Bacteria root Soybean ####
bacteria.norm.root.soy.R3 <- bacteria.css.norm %>% 
  subset_samples(Compartment == "Root" & Crop == "Soy" & GrowthStage == "R3") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

bacteria.norm.leaf.soy.bray = phyloseq::distance(bacteria.norm.leaf.soy.R3, "bray") # create bray-curtis distance matrix

adonis2(bacteria.norm.leaf.soy.bray~Fungicide*Treatment, as(sample_data(bacteria.norm.root.soy.R3), "data.frame"), permutations = 9999) 

#### R4 - Bacteria root Soybean ####
bacteria.norm.root.soy.R4 <- bacteria.css.norm %>% 
  subset_samples(Compartment == "Root" & Crop == "Soy" & GrowthStage == "R4") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

bacteria.norm.leaf.soy.bray = phyloseq::distance(bacteria.norm.root.soy.R4, "bray") # create bray-curtis distance matrix

adonis2(bacteria.norm.leaf.soy.bray~Fungicide*Treatment, as(sample_data(bacteria.norm.root.soy.R4), "data.frame"), permutations = 9999) 

#### R6 - Bacteria root Soybean ####
bacteria.norm.root.soy.R6 <- bacteria.css.norm %>% 
  subset_samples(Compartment == "Root" & Crop == "Soy" & GrowthStage == "R6") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

bacteria.norm.leaf.soy.bray = phyloseq::distance(bacteria.norm.root.soy.R6, "bray") # create bray-curtis distance matrix

adonis2(bacteria.norm.leaf.soy.bray~Fungicide*Treatment, as(sample_data(bacteria.norm.root.soy.R6), "data.frame"), permutations = 9999) 
``` 

TABLE S5
```{r CORN ROOT - FUNGICIDE}
#### Full Model ####
bacteria.norm.root.corn <- bacteria.css.norm %>% 
  subset_samples(Compartment == "Root" & Crop == "Corn") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

bacteria.norm.root.corn.bray = phyloseq::distance(bacteria.norm.root.corn, "bray") # create bray-curtis distance matrix

adonis2(bacteria.norm.root.corn.bray~Fungicide*Treatment*GrowthStage, as(sample_data(bacteria.norm.root.corn), "data.frame"))

#### v6 - Bacteria Root Corn ####
bacteria.norm.root.corn.V6 <- bacteria.css.norm %>% 
  subset_samples(Compartment == "Root" & Crop == "Corn" & GrowthStage == "V6") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

bacteria.norm.leaf.corn.bray = phyloseq::distance(bacteria.norm.root.corn.V6, "bray") # create bray-curtis distance matrix

adonis2(bacteria.norm.leaf.corn.bray~Fungicide*Treatment, as(sample_data(bacteria.norm.root.corn.V6), "data.frame"), permutations = 9999) 

#### v8 - Bacteria Root Corn ####
bacteria.norm.root.corn.V8 <- bacteria.css.norm %>% 
  subset_samples(Compartment == "Root" & Crop == "Corn" & GrowthStage == "V8") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

bacteria.norm.leaf.corn.bray = phyloseq::distance(bacteria.norm.root.corn.V8, "bray") # create bray-curtis distance matrix

adonis2(bacteria.norm.leaf.corn.bray~Fungicide*Treatment, as(sample_data(bacteria.norm.root.corn.V8), "data.frame"), permutations = 9999) 

#### v15 - Bacteria Root Corn ####
bacteria.norm.root.corn.V15 <- bacteria.css.norm %>% 
  subset_samples(Compartment == "Root" & Crop == "Corn" & GrowthStage == "V15") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

bacteria.norm.leaf.corn.bray = phyloseq::distance(bacteria.norm.root.corn.V15, "bray") # create bray-curtis distance matrix

adonis2(bacteria.norm.leaf.corn.bray~Fungicide*Treatment, as(sample_data(bacteria.norm.root.corn.V15), "data.frame"), permutations = 9999) 
``` 

TABLE S5
```{r CORN LEAVES - FUNGICIDE}
#### Full Model ####
bacteria.norm.leaves.corn <- bacteria.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Corn") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

bacteria.norm.leaf.corn.bray = phyloseq::distance(bacteria.norm.leaves.corn, "bray") # create bray-curtis distance matrix

adonis2(bacteria.norm.leaf.corn.bray~Fungicide*Treatment*GrowthStage, as(sample_data(bacteria.norm.leaves.corn), "data.frame"))

#### v6 - Bacteria leaf Corn ####
bacteria.norm.leaf.corn.V6 <- bacteria.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Corn" & GrowthStage == "V6") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

bacteria.norm.leaf.corn.bray = phyloseq::distance(bacteria.norm.leaf.corn.V6, "bray") # create bray-curtis distance matrix

adonis2(bacteria.norm.leaf.corn.bray~Fungicide*Treatment, as(sample_data(bacteria.norm.leaf.corn.V6), "data.frame"), permutations = 9999) 

#### v8 - Bacteria leaf Corn ####
bacteria.norm.leaf.corn.V8 <- bacteria.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Corn" & GrowthStage == "V8") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

bacteria.norm.leaf.corn.bray = phyloseq::distance(bacteria.norm.leaf.corn.V8, "bray") # create bray-curtis distance matrix

adonis2(bacteria.norm.leaf.corn.bray~Fungicide*Treatment, as(sample_data(bacteria.norm.leaf.corn.V8), "data.frame"), permutations = 9999) 

#### v15 - Bacteria leaf Corn ####
bacteria.norm.leaf.corn.V15 <- bacteria.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Corn" & GrowthStage == "V15") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

bacteria.norm.leaf.corn.bray = phyloseq::distance(bacteria.norm.leaf.corn.V15, "bray") # create bray-curtis distance matrix

adonis2(bacteria.norm.leaf.corn.bray~Fungicide*Treatment, as(sample_data(bacteria.norm.leaf.corn.V15), "data.frame"), permutations = 9999) 
``` 

# Fungi

```{r}
# Restore the object
fungi.no.norm <- readRDS(file = "Preprocessing/Fungicide_Fungi_RootsAndLeaves_1000readsmin_nonorm_022421.rds")
# Restore the object
fungi.css.norm <- readRDS(file = "Preprocessing/Fungicide_Fungi_RootsAndLeaves_1000seqMin_CSSNorm_022421.rds")
```

```{r}
fungi.no.norm.soy <- fungi.no.norm %>% 
  subset_samples(Crop == "Soy") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.css.norm.soy <- fungi.css.norm %>% 
  subset_samples(Crop == "Soy") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.no.norm.corn <- fungi.no.norm %>% 
  subset_samples(Crop == "Corn") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.css.norm.corn <- fungi.css.norm %>% 
  subset_samples(Crop == "Corn" ) %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 
```

## Alpha diversity on fungi
-Switch out the alpha diversity estimate to test different measures
```{r}
#This line is to subset the dataset to a specific lineage
#physeq_prok_no_norm_sphingo = subset_taxa(bacteria.no.norm, Genus=="Hymenobacter") %>% phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE)

alpha.diversity.calc(fungi.no.norm.soy)[[1]]
alpha.diversity.calc(fungi.no.norm.corn)[[1]]
```
Seems that the richness is mostly dependent on growthstage management and compartment
In Corn leaves there may be an effect of fungicide on richness when combining both managements (FungicideXGrowthStage interaction) meaning that fungicide altered the richness similarly across levels of management 

Plot alpha diversity, just switch out the data and the y axis to get different plots
```{r COMPARTMENTxDATExFUNGICIDE}
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

sample.data.fungi.soy <- alpha.diversity.calc(fungi.no.norm.soy)[[2]]
sample.data.fungi.corn <- alpha.diversity.calc(fungi.no.norm.corn)[[2]]

ggplot(sample.data.fungi.corn, aes(x = DateSampled, y = richness, color = Treatment, linetype = Fungicide)) + 
  stat_summary(fun.y=mean,geom="line") +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.5) +
  ylab("S") + 
  #ggtitle("Fungi") + 
  xlab("")+
  scale_color_manual(values=cbbPalette) +
  #scale_linetype_manual(values = c(rep("solid", 2), rep("dashed", 2))) +
  #stat_compare_means(method = "t.test") +
  theme_classic() +
  facet_wrap(~Crop*Compartment, scales = "free_x")
```
So it seems that fungicide affected the number of corn leaf fungal taxa, and also altered how dominant the communities were. Fungicide treated corn were less rich and more dominant communities. 

We are going to check certain fungal lineages, like the Bulleribacideaceae because those were impacted by the fungicide. We know this from future analyses. 
```{r}
physeq_fungi_nonorm_Bul = subset_taxa(fungi.no.norm) %>% phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE)

# FUNGI 
physeq_fungi_nonorm_Bul@sam_data$shannon <- estimate_richness(physeq_fungi_nonorm_Bul, measures=c("Shannon"))$Shannon
physeq_fungi_nonorm_Bul@sam_data$chao <- estimate_richness(physeq_fungi_nonorm_Bul, measures=c("Chao1"))$Chao1
physeq_fungi_nonorm_Bul@sam_data$invsimpson <- estimate_richness(physeq_fungi_nonorm_Bul, measures=c("InvSimpson"))$InvSimpson
physeq_fungi_nonorm_Bul@sam_data$sequence_depth <- as.numeric(sample_sums(physeq_fungi_nonorm_Bul))
physeq_fungi_nonorm_Bul@sam_data$richness <- estimate_richness(physeq_fungi_nonorm_Bul, measures=c("Observed"))$Observed
physeq_fungi_nonorm_Bul@sam_data$even <- physeq_fungi_nonorm_Bul@sam_data$shannon/log(physeq_fungi_nonorm_Bul@sam_data$richness)

sample.data.fungi <- data.frame(physeq_fungi_nonorm_Bul@sam_data)
sample.data.fungi$DateSampled <- as.Date(sample.data.fungi$DateSampled, "%d-%b-%y")

Soy.bull.richness <- sample.data.fungi %>%
  subset(Crop == "Soy" & Compartment == "Leaf") %>%
ggplot(aes(x = DateSampled, y = richness, group = Fungicide, color = Fungicide, linetype = Fungicide)) + 
  stat_summary(fun.y=mean,geom="line") +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.5) +
  ylab("S") + 
  #ggtitle("Fungi") + 
  xlab("")+
  scale_color_manual(values=cbbPalette) +
  #scale_linetype_manual(values = c(rep("solid", 2), rep("dashed", 2))) +
  stat_compare_means(method = "t.test") +
  theme_classic() +
  facet_wrap(~Crop*Compartment*Treatment, scales = "free_x")

Corn.bull.richness <- sample.data.fungi %>%
  subset(Crop == "Corn" & Compartment == "Leaf") %>%
ggplot(aes(x = DateSampled, y = richness, group = Fungicide, color = Fungicide, linetype = Fungicide)) + 
  stat_summary(fun.y=mean,geom="line") +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.5) +
  ylab("S") + 
  #ggtitle("Fungi") + 
  xlab("")+
  scale_color_manual(values=cbbPalette) +
  #scale_linetype_manual(values = c(rep("solid", 2), rep("dashed", 2))) +
  stat_compare_means(method = "t.test") +
  theme_classic() +
  facet_wrap(~Crop*Compartment*Treatment, scales = "free_x")

plot_grid(Corn.bull.richness,
          Soy.bull.richness,
          labels = "AUTO", ncol = 1, nrow = 2)
```

## FUNGI Beta-diversity

TABLE S4
```{r SOY LEAF - FUNGICIDE ADONIS}
#### Full Model ####
fungi.norm.leaves.soy <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Soy") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.soy.bray = phyloseq::distance(fungi.norm.leaves.soy, "bray") # create bray-curtis distance matrix

set.seed(12325)
adonis2(fungi.norm.leaf.soy.bray~Fungicide + Treatment + GrowthStage + Fungicide:Treatment + Fungicide:GrowthStage + Fungicide:Treatment:GrowthStage, as(sample_data(fungi.norm.leaves.soy), "data.frame"))

###### R3 - fungi leaves Soybean #####
fungi.norm.leaf.soy.R3 <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Soy" & GrowthStage == "R3") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.soy.bray = phyloseq::distance(fungi.norm.leaf.soy.R3, "bray") # create bray-curtis distance matrix

adonis2(fungi.norm.leaf.soy.bray~Fungicide*Treatment, as(sample_data(fungi.norm.leaf.soy.R3), "data.frame"), permutations = 9999) 

###### R4 - fungi leaves Soybean ######
fungi.norm.leaf.soy.R4 <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Soy" & GrowthStage == "R4") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.soy.bray = phyloseq::distance(fungi.norm.leaf.soy.R4, "bray") # create bray-curtis distance matrix

adonis2(fungi.norm.leaf.soy.bray~Fungicide*Treatment, as(sample_data(fungi.norm.leaf.soy.R4), "data.frame"), permutations = 9999) 

###### R6 - fungi leaves Soybean ######
fungi.norm.leaf.soy.R6 <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Soy" & GrowthStage == "R6") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.soy.bray = phyloseq::distance(fungi.norm.leaf.soy.R6, "bray") # create bray-curtis distance matrix

adonis2(fungi.norm.leaf.soy.bray~Fungicide*Treatment, as(sample_data(fungi.norm.leaf.soy.R6), "data.frame"), permutations = 9999) 
``` 

TABLE S4
```{r SOY ROOT - FUNGICIDE}
#### Full Model ####
fungi.norm.root.soy <- fungi.css.norm %>% 
  subset_samples(Compartment == "Root" & Crop == "Soy") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.root.soy.bray = phyloseq::distance(fungi.norm.root.soy, "bray") # create bray-curtis distance matrix

set.seed(12325)
adonis2(fungi.norm.root.soy.bray~Fungicide + Treatment + GrowthStage + Fungicide:Treatment + Fungicide:GrowthStage + Fungicide:Treatment:GrowthStage, as(sample_data(fungi.norm.root.soy), "data.frame"))

###### R3 - fungi root Soybean ######
fungi.norm.root.soy.R3 <- fungi.css.norm %>% 
  subset_samples(Compartment == "Root" & Crop == "Soy" & GrowthStage == "R3") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.soy.bray = phyloseq::distance(fungi.norm.leaf.soy.R3, "bray") # create bray-curtis distance matrix

adonis2(fungi.norm.leaf.soy.bray~Fungicide*Treatment, as(sample_data(fungi.norm.root.soy.R3), "data.frame"), permutations = 9999) 

###### R4 - fungi root Soybean ######
fungi.norm.root.soy.R4 <- fungi.css.norm %>% 
  subset_samples(Compartment == "Root" & Crop == "Soy" & GrowthStage == "R4") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.soy.bray = phyloseq::distance(fungi.norm.root.soy.R4, "bray") # create bray-curtis distance matrix

adonis2(fungi.norm.leaf.soy.bray~Fungicide*Treatment, as(sample_data(fungi.norm.root.soy.R4), "data.frame"), permutations = 9999) 

###### R6 - fungi root Soybean ######
fungi.norm.root.soy.R6 <- fungi.css.norm %>% 
  subset_samples(Compartment == "Root" & Crop == "Soy" & GrowthStage == "R6") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.soy.bray = phyloseq::distance(fungi.norm.root.soy.R6, "bray") # create bray-curtis distance matrix

adonis2(fungi.norm.leaf.soy.bray~Fungicide*Treatment, as(sample_data(fungi.norm.root.soy.R6), "data.frame"), permutations = 9999) 
``` 

TABLE S4
```{r CORN ROOT - FUNGICIDE}
#### Full Model ####
fungi.norm.root.corn <- fungi.css.norm %>% 
  subset_samples(Compartment == "Root" & Crop == "Corn") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.root.corn.bray = phyloseq::distance(fungi.norm.root.corn, "bray") # create bray-curtis distance matrix

adonis2(fungi.norm.root.corn.bray~Fungicide + Treatment + GrowthStage + Fungicide:Treatment + Fungicide:GrowthStage + Fungicide:GrowthStage:Treatment , as(sample_data(fungi.norm.root.corn), "data.frame"))

###### v6 - fungi Root Corn ######
fungi.norm.root.corn.V6 <- fungi.css.norm %>% 
  subset_samples(Compartment == "Root" & Crop == "Corn" & GrowthStage == "V6") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.corn.bray = phyloseq::distance(fungi.norm.root.corn.V6, "bray") # create bray-curtis distance matrix

adonis2(fungi.norm.leaf.corn.bray~Fungicide*Treatment, as(sample_data(fungi.norm.root.corn.V6), "data.frame"), permutations = 9999) 

###### v8 - fungi Root Corn ######
fungi.norm.root.corn.V8 <- fungi.css.norm %>% 
  subset_samples(Compartment == "Root" & Crop == "Corn" & GrowthStage == "V8") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.corn.bray = phyloseq::distance(fungi.norm.root.corn.V8, "bray") # create bray-curtis distance matrix

adonis2(fungi.norm.leaf.corn.bray~Fungicide*Treatment, as(sample_data(fungi.norm.root.corn.V8), "data.frame"), permutations = 9999) 

###### v15 - fungi Root Corn ######
fungi.norm.root.corn.V15 <- fungi.css.norm %>% 
  subset_samples(Compartment == "Root" & Crop == "Corn" & GrowthStage == "V15") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.corn.bray = phyloseq::distance(fungi.norm.root.corn.V15, "bray") # create bray-curtis distance matrix

adonis2(fungi.norm.leaf.corn.bray~Fungicide*Treatment, as(sample_data(fungi.norm.root.corn.V15), "data.frame"), permutations = 9999) 
``` 

TABLE S4
```{r CORN LEAVES - FUNGICIDE}
#### Full Model ####
fungi.norm.leaf.corn <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Corn") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.corn.bray = phyloseq::distance(fungi.norm.leaf.corn, "bray") # create bray-curtis distance matrix

set.seed(12325)
adonis2(fungi.norm.leaf.corn.bray~Fungicide + Treatment + GrowthStage + Fungicide:Treatment + Fungicide:GrowthStage + Fungicide:Treatment:GrowthStage, as(sample_data(fungi.norm.leaf.corn), "data.frame"))

###### v6 - fungi leaf Corn ######
fungi.norm.leaf.corn.V6 <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Corn" & GrowthStage == "V6") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.corn.bray = phyloseq::distance(fungi.norm.leaf.corn.V6, "bray") # create bray-curtis distance matrix

adonis2(fungi.norm.leaf.corn.bray~Fungicide*Treatment, as(sample_data(fungi.norm.leaf.corn.V6), "data.frame"), permutations = 9999) 

###### v8 - fungi leaf Corn ######
fungi.norm.leaf.corn.V8 <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Corn" & GrowthStage == "V8") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.corn.bray = phyloseq::distance(fungi.norm.leaf.corn.V8, "bray") # create bray-curtis distance matrix

adonis2(fungi.norm.leaf.corn.bray~Fungicide*Treatment, as(sample_data(fungi.norm.leaf.corn.V8), "data.frame"), permutations = 9999) 

###### v15 - fungi leaf Corn ######
fungi.norm.leaf.corn.V15 <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Corn" & GrowthStage == "V15") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.corn.bray = phyloseq::distance(fungi.norm.leaf.corn.V15, "bray") # create bray-curtis distance matrix

adonis2(fungi.norm.leaf.corn.bray~Fungicide*Treatment, as(sample_data(fungi.norm.leaf.corn.V15), "data.frame"), permutations = 9999) 
``` 

## SOYBEAN TREATMENT x FUNGICIDE
Since fungicides seemed to affect fungal composition in the leaves after fungicide treatment, and there was occasionally a managementXFungicideXgrowthstage interaction we will look at the effect of fungicide within each growthstage and treatment. We will also test for effects of betadispersion and use anosim to corroborate the permanova results
```{r SUBSETTING LEAF SOY}
fungi.norm.leaf.soy.R3.conventional <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Soy" & GrowthStage == "R3" & Treatment == "T1") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.soy.R3.notill <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Soy" & GrowthStage == "R3" & Treatment == "T2") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.soy.R4.conventional <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Soy" & GrowthStage == "R4" & Treatment == "T1") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.soy.R4.notill <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Soy" & GrowthStage == "R4" & Treatment == "T2") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.soy.R6.conventional <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Soy" & GrowthStage == "R6" & Treatment == "T1") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.soy.R6.notill <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Soy" & GrowthStage == "R6" & Treatment == "T2") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 
```

Table S3
```{r ADONIS WITHIN GROWTH STAGE and TREATMENT}
fungicide.adonis(fungi.norm.leaf.soy.R3.conventional) 
fungicide.adonis(fungi.norm.leaf.soy.R3.notill) 
fungicide.adonis(fungi.norm.leaf.soy.R4.conventional) 
fungicide.adonis(fungi.norm.leaf.soy.R4.notill) 
fungicide.adonis(fungi.norm.leaf.soy.R6.conventional) 
fungicide.adonis(fungi.norm.leaf.soy.R6.notill) 

fungicide.betadisper(fungi.norm.leaf.soy.R3.conventional) 
fungicide.betadisper(fungi.norm.leaf.soy.R3.notill)
fungicide.betadisper(fungi.norm.leaf.soy.R4.conventional) 
fungicide.betadisper(fungi.norm.leaf.soy.R4.notill) 
fungicide.betadisper(fungi.norm.leaf.soy.R6.conventional) 
fungicide.betadisper(fungi.norm.leaf.soy.R6.notill) 

fungicide.anosim(fungi.norm.leaf.soy.R3.conventional) 
fungicide.anosim(fungi.norm.leaf.soy.R3.notill)
fungicide.anosim(fungi.norm.leaf.soy.R4.conventional) 
fungicide.anosim(fungi.norm.leaf.soy.R4.notill) 
fungicide.anosim(fungi.norm.leaf.soy.R6.conventional) 
fungicide.anosim(fungi.norm.leaf.soy.R6.notill) 
```
Before fungicides were applied only treatment was significant effect on fungal soybean leaf composition 

- The results of the PERMANOVA indicate that after 1 week and 1 month the fungicide effect was very strong on altering the fungal composition in soybean leaves 
- The results of Betadispersion test tell us that the homogeneity of variances assumption for the PERMANOVA was not violated and that those results are likely truly due to biological differences not differences in variation. 
- The results of the ANOSIM corroborate the results of the PERMANOVA 

So we will produce PCOA plots of the effect of fungicide within treatments but separated by growth stage and treatment to match the soybean data
```{r SUBSETTING LEAF CORN}
fungi.norm.leaf.corn.V6.conventional <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Corn" & GrowthStage == "V6" & Treatment == "T1") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.corn.V6.notill <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Corn" & GrowthStage == "V6" & Treatment == "T2") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.corn.V8.conventional <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Corn" & GrowthStage == "V8" & Treatment == "T1") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.corn.V8.notill <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Corn" & GrowthStage == "V8" & Treatment == "T2") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE)

fungi.norm.leaf.corn.V15.conventional <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Corn" & GrowthStage == "V15" & Treatment == "T1") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

fungi.norm.leaf.corn.V15.notill <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Corn" & GrowthStage == "V15" & Treatment == "T2") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 
```

Table S3
```{r ADONIS WITHIN GROWTH STAGE and TREATMENT}
fungicide.adonis(fungi.norm.leaf.corn.V6.conventional) 
fungicide.adonis(fungi.norm.leaf.corn.V6.notill) 
fungicide.adonis(fungi.norm.leaf.corn.V8.conventional)
fungicide.adonis(fungi.norm.leaf.corn.V8.notill) 
fungicide.adonis(fungi.norm.leaf.corn.V15.conventional) 
fungicide.adonis(fungi.norm.leaf.corn.V15.notill) 

fungicide.betadisper(fungi.norm.leaf.corn.V6.conventional) 
fungicide.betadisper(fungi.norm.leaf.corn.V6.notill) 
fungicide.betadisper(fungi.norm.leaf.corn.V8.conventional) 
fungicide.betadisper(fungi.norm.leaf.corn.V8.notill) 
fungicide.betadisper(fungi.norm.leaf.corn.V15.conventional) 
fungicide.betadisper(fungi.norm.leaf.corn.V15.notill) 

fungicide.anosim(fungi.norm.leaf.corn.V6.conventional)
fungicide.anosim(fungi.norm.leaf.corn.V6.notill)
fungicide.anosim(fungi.norm.leaf.corn.V8.conventional)
fungicide.anosim(fungi.norm.leaf.corn.V8.notill)
fungicide.anosim(fungi.norm.leaf.corn.V15.conventional)
fungicide.anosim(fungi.norm.leaf.corn.V15.notill)
```
Before fungicides were applied only treatment was significant effect on fungal soybean leaf composition 
1 week after fungicides were applied fungicide represented about 6.5% variation in soybean leaf composition 
1 month after fungicide were applied fungicide was not a significant factor. 

## CAP analysis - Fig. 1

```{r CAP}
######### CAP of fungicide effect on soybean leaves 0 days post fungicide management ###################
fungi.norm.leaf.soy.0dpf <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Soy" & GrowthStage == "R3") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

cap_fungicide_soy_leaf_0dpf <- ordinate(fungi.norm.leaf.soy.0dpf,"CAP","bray", ~Fungicide)

## Calculate proporition of variation table
var_tab_cap_fung_soy_0dpf <- variability_table(cap_fungicide_soy_leaf_0dpf)

## Set seed for reproducibilty of permutational testing and permute CAP ordination for significance testing
set.seed(8046)  # zip code Agroscope ZH
permutest(cap_fungicide_soy_leaf_0dpf, permutations=how(nperm=9999))

## PERMANOVA and BETADISPER
fungicide.adonis(fungi.norm.leaf.soy.0dpf) # should be the same as above
fungicide.betadisper(fungi.norm.leaf.soy.0dpf)
fungicide.anosim(fungi.norm.leaf.soy.0dpf)

plot1 <- plot_ordination(fungi.norm.leaf.soy.0dpf,cap_fungicide_soy_leaf_0dpf,color="Fungicide",shape="Treatment")

cap_fungicide_soy_leaf_soy_0dpf <- ggplot(plot1$data, aes(x = CAP1, y = MDS1, fill = Fungicide, shape = Treatment)) +
  geom_point(size=4, alpha = 0.7)+
  scale_shape_manual(values=c(21,22), label = c("Conv.", "No-till"), name = "")+
  scale_fill_manual(values=cbbPalette, label = c("Control", "Fungicide"), name = "")+
  xlab("CAP1 (1.8%)") + 
  ylab("MDS1 (38.9%)") +
  theme(legend.position="bottom",legend.title=element_blank(),legend.key = element_blank())+
  guides(fill=guide_legend(override.aes=list(shape=21))) +
  ggtitle("Soybean Leaf - 0-dpf", subtitle = bquote(paste(.(round(var_tab_cap_fung_soy_0dpf["constrained","proportion"],2)*100),"% of total variation (CI=",
                       .(round(cca_ci(cap_fungicide_soy_leaf_0dpf)[1],2)*100),"%, ",
                       .(round(cca_ci(cap_fungicide_soy_leaf_0dpf)[2],2)*100),"%); ", "P = 0.51" )))+
  theme(plot.title = element_text(size = 10, face = "bold")) + 
  theme_bw()

######### CAP of fungicide effect on soybean leaves 13 days post fungicide management ###################
fungi.norm.leaf.soy.13dpf <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Soy" & GrowthStage == "R4") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

cap_fungicide_soy_leaf_13dpf <- ordinate(fungi.norm.leaf.soy.13dpf,"CAP","bray", ~Fungicide)

## Calculate proporition of variation table
var_tab_cap_fung_soy_13dpf <- variability_table(cap_fungicide_soy_leaf_13dpf)

## Set seed for reproducibilty of permutational testing and permute CAP ordination for significance testing
set.seed(8046)  # zip code Agroscope ZH
permutest(cap_fungicide_soy_leaf_13dpf, permutations=how(nperm=9999))

## PERMANOVA and BETADISPER
fungicide.adonis(fungi.norm.leaf.soy.13dpf) # should be the same as above
fungicide.betadisper(fungi.norm.leaf.soy.13dpf)
fungicide.anosim(fungi.norm.leaf.soy.13dpf)

plot1 <- plot_ordination(fungi.norm.leaf.soy.13dpf,cap_fungicide_soy_leaf_13dpf,color="Fungicide",shape="Treatment")

cap_fungicide_soy_leaf_soy_13dpf <- ggplot(plot1$data, aes(x = CAP1, y = MDS1, fill = Fungicide, shape = Treatment)) +
  geom_point(size=4, alpha = 0.7)+
  scale_shape_manual(values=c(21,22))+
  scale_fill_manual(values=cbbPalette)+
  xlab("CAP1 (12.4%)") + 
  ylab("MDS1 (21.9%)") +
  theme(legend.position="bottom",legend.title=element_blank(),legend.key = element_blank())+
  guides(fill=guide_legend(override.aes=list(shape=21))) +
  ggtitle("Soybean Leaf - 13-dpf", subtitle = bquote(paste(.(round(var_tab_cap_fung_soy_13dpf["constrained","proportion"],2)*100),"% of total variation (CI=",
                       .(round(cca_ci(cap_fungicide_soy_leaf_13dpf)[1],2)*100),"%, ",
                       .(round(cca_ci(cap_fungicide_soy_leaf_13dpf)[2],2)*100),"%); ", "P < 0.001" )))+
  theme(plot.title = element_text(size = 10, face = "bold")) + 
  theme_bw()

######### CAP of fungicide effect on soybean leaves 33 days post fungicide management ###################
fungi.norm.leaf.soy.24dpf <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Soy" & GrowthStage == "R6") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

cap_fungicide_soy_leaf_24dpf <- ordinate(fungi.norm.leaf.soy.24dpf,"CAP","bray", ~Fungicide)

## Calculate proporition of variation table
var_tab_cap_fung_soy_24dpf <- variability_table(cap_fungicide_soy_leaf_24dpf)

## Set seed for reproducibilty of permutational testing and permute CAP ordination for significance testing
set.seed(8046)  # zip code Agroscope ZH
permutest(cap_fungicide_soy_leaf_24dpf, permutations=how(nperm=9999))

## PERMANOVA and BETADISPER
fungicide.adonis(fungi.norm.leaf.soy.24dpf) # should be the same as above
fungicide.betadisper(fungi.norm.leaf.soy.24dpf)
fungicide.anosim(fungi.norm.leaf.soy.24dpf)

plot1 <- plot_ordination(fungi.norm.leaf.soy.24dpf,cap_fungicide_soy_leaf_24dpf,color="Fungicide",shape="Treatment")

cap_fungicide_soy_leaf_soy_24dpf <- ggplot(plot1$data, aes(x = CAP1, y = MDS1, fill = Fungicide, shape = Treatment)) +
  geom_point(size=4, alpha = 0.7)+
  scale_shape_manual(values=c(21,22))+
  scale_fill_manual(values=cbbPalette)+
  xlab("CAP1 (10.6%)") + 
  ylab("MDS1 (18.3%)") +
  theme(legend.position="bottom",legend.title=element_blank(),legend.key = element_blank())+
  guides(fill=guide_legend(override.aes=list(shape=21))) +
  ggtitle("Soybean Leaf - 33-dpf", subtitle = bquote(paste(.(round(var_tab_cap_fung_soy_24dpf["constrained","proportion"],2)*100),"% of total variation (CI=",
                       .(round(cca_ci(cap_fungicide_soy_leaf_24dpf)[1],2)*100),"%, ",
                       .(round(cca_ci(cap_fungicide_soy_leaf_24dpf)[2],2)*100),"%); ", "P < 0.001" )))+
  theme(plot.title = element_text(size = 10, face = "bold")) + 
  theme_bw()

######### CAP of fungicide effect on corn leaves 0 days post fungicide management ###################
fungi.norm.leaf.corn.0dpf <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Corn" & GrowthStage == "V6") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

cap_fungicide_corn_leaf_0dpf <- ordinate(fungi.norm.leaf.corn.0dpf,"CAP","bray", ~Fungicide)

## Calculate proporition of variation table
var_tab_cap_fung_corn_0dpf <- variability_table(cap_fungicide_corn_leaf_0dpf)

## Set seed for reproducibilty of permutational testing and permute CAP ordination for significance testing
set.seed(8046)  # zip code Agroscope ZH
permutest(cap_fungicide_corn_leaf_0dpf, permutations=how(nperm=9999))

## PERMANOVA and BETADISPER
fungicide.adonis(fungi.norm.leaf.corn.0dpf) # should be the same as above
fungicide.betadisper(fungi.norm.leaf.corn.0dpf)
fungicide.anosim(fungi.norm.leaf.corn.0dpf)

plot1 <- plot_ordination(fungi.norm.leaf.corn.0dpf,cap_fungicide_corn_leaf_0dpf,color="Fungicide",shape="Treatment")

cap_fungicide_soy_leaf_corn_0dpf <- ggplot(plot1$data, aes(x = CAP1, y = MDS1, fill = Fungicide, shape = Treatment)) +
  geom_point(size=4, alpha = 0.7)+
  scale_shape_manual(values=c(21,22))+
  scale_fill_manual(values=cbbPalette)+
  xlab("CAP1 (3.1%)") + 
  ylab("MDS1 (16.7%)") +
  theme(legend.position="bottom",legend.title=element_blank(),legend.key = element_blank())+
  guides(fill=guide_legend(override.aes=list(shape=21))) +
  ggtitle("Corn Leaf - 0-dpf", subtitle = bquote(paste(.(round(var_tab_cap_fung_corn_0dpf["constrained","proportion"],2)*100),"% of total variation (CI=",
                       .(round(cca_ci(cap_fungicide_corn_leaf_0dpf)[1],2)*100),"%, ",
                       .(round(cca_ci(cap_fungicide_corn_leaf_0dpf)[2],2)*100),"%); ", "P = 0.075" )))+
  theme(plot.title = element_text(size = 10, face = "bold")) + 
  theme_bw()

######### CAP of fungicide effect on corn leaves 9 days post fungicide management ###################
fungi.norm.leaf.corn.9dpf <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Corn" & GrowthStage == "V8") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

cap_fungicide_corn_leaf_9dpf <- ordinate(fungi.norm.leaf.corn.9dpf,"CAP","bray", ~Fungicide)

## Calculate proporition of variation table
var_tab_cap_fung_corn_9dpf <- variability_table(cap_fungicide_corn_leaf_9dpf)

## Set seed for reproducibilty of permutational testing and permute CAP ordination for significance testing
set.seed(8046)  # zip code Agroscope ZH
permutest(cap_fungicide_corn_leaf_9dpf, permutations=how(nperm=9999))

## PERMANOVA and BETADISPER
fungicide.adonis(fungi.norm.leaf.corn.9dpf) # should be the same as above
fungicide.betadisper(fungi.norm.leaf.corn.9dpf)
fungicide.anosim(fungi.norm.leaf.corn.9dpf)

plot1 <- plot_ordination(fungi.norm.leaf.corn.9dpf,cap_fungicide_corn_leaf_9dpf,color="Fungicide",shape="Treatment")

cap_fungicide_soy_leaf_corn_9dpf <- ggplot(plot1$data, aes(x = CAP1, y = MDS1, fill = Fungicide, shape = Treatment)) +
  geom_point(size=4, alpha = 0.7)+
  scale_shape_manual(values=c(21,22))+
  scale_fill_manual(values=cbbPalette)+
  xlab("CAP1 (8.2%)") + 
  ylab("MDS1 (18.4%)") +
  theme(legend.position="bottom",legend.title=element_blank(),legend.key = element_blank())+
  guides(fill=guide_legend(override.aes=list(shape=21))) +
  ggtitle("Corn Leaf - 9-dpf", subtitle = bquote(paste(.(round(var_tab_cap_fung_corn_9dpf["constrained","proportion"],2)*100),"% of total variation (CI=",
                       .(round(cca_ci(cap_fungicide_corn_leaf_9dpf)[1],2)*100),"%, ",
                       .(round(cca_ci(cap_fungicide_corn_leaf_9dpf)[2],2)*100),"%); ", "P < 0.001" )))+
  theme(plot.title = element_text(size = 10, face = "bold")) + 
  theme_bw()

######### CAP of fungicide effect on corn leaves 34 days post fungicide management ###################
fungi.norm.leaf.corn.34dpf <- fungi.css.norm %>% 
  subset_samples(Compartment == "Leaf" & Crop == "Corn" & GrowthStage == "V15") %>%
  phyloseq::filter_taxa(function(x) sum(x) > 0, TRUE) 

cap_fungicide_corn_leaf_34dpf <- ordinate(fungi.norm.leaf.corn.34dpf,"CAP","bray", ~Fungicide)

## Calculate proporition of variation table
var_tab_cap_fung_corn_34dpf <- variability_table(cap_fungicide_corn_leaf_34dpf)

## Set seed for reproducibilty of permutational testing and permute CAP ordination for significance testing
set.seed(8046)  # zip code Agroscope ZH
permutest(cap_fungicide_corn_leaf_34dpf, permutations=how(nperm=9999))

## PERMANOVA and BETADISPER
fungicide.adonis(fungi.norm.leaf.corn.34dpf) # should be the same as above
fungicide.betadisper(fungi.norm.leaf.corn.34dpf)
fungicide.anosim(fungi.norm.leaf.corn.34dpf)

plot1 <- plot_ordination(fungi.norm.leaf.corn.34dpf,cap_fungicide_corn_leaf_34dpf,color="Fungicide",shape="Treatment")

cap_fungicide_soy_leaf_corn_34dpf <- ggplot(plot1$data, aes(x = CAP1, y = MDS1, fill = Fungicide, shape = Treatment)) +
  geom_point(size=4, alpha = 0.7)+
  scale_shape_manual(values=c(21,22))+
  scale_fill_manual(values=cbbPalette)+
  xlab("CAP1 (3.4%)") + 
  ylab("MDS1 (19.7%)") +
  theme(legend.position="bottom",legend.title=element_blank(),legend.key = element_blank())+
  guides(fill=guide_legend(override.aes=list(shape=21))) +
  ggtitle("Corn Leaf - 34-dpf", subtitle = bquote(paste(.(round(var_tab_cap_fung_corn_34dpf["constrained","proportion"],2)*100),"% of total variation (CI=",
                       .(round(cca_ci(cap_fungicide_corn_leaf_34dpf)[1],2)*100),"%, ",
                       .(round(cca_ci(cap_fungicide_corn_leaf_34dpf)[2],2)*100),"%); ", "P = 0.078" )))+
  theme(plot.title = element_text(size = 10, face = "bold")) + 
  theme_bw()




```

```{r FIG 1}
######## PLOT FIGURE 1 #######
ggpubr::ggarrange(cap_fungicide_soy_leaf_soy_0dpf, cap_fungicide_soy_leaf_soy_13dpf, cap_fungicide_soy_leaf_soy_24dpf,
                  cap_fungicide_soy_leaf_corn_0dpf, cap_fungicide_soy_leaf_corn_9dpf, cap_fungicide_soy_leaf_corn_34dpf,
                  common.legend = TRUE, nrow = 2, ncol = 3, labels = c("A", "B", "C", "D", "E", "F"))
```

Next we will use a differential abundance analysis to determine the fungal taxa that were altered by the fungicide. 
-The questions we are after are:
-- are the taxa affected similar across both crops? 
-- was the effect of fungicide transient (ie did they recover), or did some taxa go locally extinct?
-- in soybean was there differential recovery of these taxa depending on treatment?







